<!-- src/routes/competitions/results/+page.svelte -->
<script>
  import { onMount, onDestroy } from 'svelte';
  import { goto } from '$app/navigation';
  import { userProfile } from '$lib/stores/userProfile';
  import { supabase } from '$lib/supabaseClient';
  
  let competitions = [];
  let selectedCompetition = null;
  let results = [];
  let isLoading = true;
  let isLoadingResults = false;
  let error = null;

  // Scoresheet modal state
  let showScoresheetModal = false;
  let selectedScoresheet = null;
  let loadingScoresheet = false;
  let scoresheetError = null;

  onMount(() => {
    loadPublishedCompetitions();
    setupEventHandlers();
  });

  // Removed tab switching reload - causes issues with Supabase tab switching
  function setupEventHandlers() {
    // Tab visibility handling removed for better Supabase compatibility
    return () => {
      // No cleanup needed now
    };
  }

  onDestroy(() => {
    // Cleanup handled by setupEventHandlers return
  });

  // Helper functions for ranking points calculation
  function getPointsForRanking(rankPosition) {
    // Point system: 1st=3pts, 2nd=2pts, 3rd=1pt, others=0pts
    switch (rankPosition) {
      case 1: return 3;
      case 2: return 2;
      case 3: return 1;
      default: return 0;
    }
  }

  function calculateEntryPoints(entryId, categoryId, rankings, rankingGroups) {
    // Get all rankings for this entry from all judges
    let entryRankings = [];
    
    // Check if entry belongs to a custom ranking group
    let groupId = null;
    for (const group of rankingGroups) {
      let categoryIds;
      try {
        categoryIds = Array.isArray(group.bjcp_category_ids) 
          ? group.bjcp_category_ids 
          : JSON.parse(group.bjcp_category_ids);
      } catch (e) {
        console.warn('Failed to parse bjcp_category_ids for group:', group.id);
        continue;
      }
      
      if (categoryIds.includes(categoryId)) {
        groupId = group.id;
        break;
      }
    }
    
    if (groupId) {
      // For custom ranking groups
      entryRankings = rankings.filter(r => 
        r.entry_id === entryId && r.ranking_group_id === groupId
      );
    } else {
      // For individual categories
      entryRankings = rankings.filter(r => 
        r.entry_id === entryId && r.bjcp_category_id === categoryId
      );
    }

    // Calculate total points from all judges
    const totalPoints = entryRankings.reduce((sum, ranking) => {
      return sum + getPointsForRanking(ranking.rank_position);
    }, 0);

    return {
      totalPoints,
      judgeCount: entryRankings.length,
      rankings: entryRankings
    };
  }

  // Load competitions with published results
  async function loadPublishedCompetitions() {
    isLoading = true;
    error = null;

    try {
      console.log('Loading published competitions...');
      
      const { data: competitionsData, error: competitionsError } = await supabase
        .from('competitions')
        .select('*')
        .eq('results_published', true)
        .order('judging_date', { ascending: false });

      if (competitionsError) throw competitionsError;

      competitions = competitionsData || [];
      console.log('Loaded', competitions.length, 'published competitions');

      // Auto-select the most recent competition if available
      if (competitions.length > 0) {
        selectedCompetition = competitions[0];
        await loadResultsForCompetition(competitions[0]);
      }

    } catch (err) {
      console.error('Error loading competitions:', err);
      error = err.message || 'Failed to load competitions';
    } finally {
      isLoading = false;
    }
  }

  // Handle competition selection from dropdown
  async function handleCompetitionSelect(event) {
    const competitionId = event.target.value;
    if (!competitionId) {
      selectedCompetition = null;
      results = [];
      return;
    }

    const competition = competitions.find(c => c.id === competitionId);
    if (competition) {
      selectedCompetition = competition;
      await loadResultsForCompetition(competition);
    }
  }

  // Load results for selected competition
  async function loadResultsForCompetition(competition) {
    isLoadingResults = true;
    error = null;

    try {
      console.log('Loading results for competition:', competition.name);

      // Get competition results with entry details
      const { data: resultsData, error: resultsError } = await supabase
        .from('competition_results')
        .select('*')
        .eq('competition_id', competition.id);

      if (resultsError) throw resultsError;

      if (!resultsData || resultsData.length === 0) {
        results = [];
        return;
      }

      // Get entry details for each result
      const entryIds = resultsData.map(r => r.entry_id);
      const { data: entriesData, error: entriesError } = await supabase
        .from('competition_entries')
        .select('*')
        .in('id', entryIds);

      if (entriesError) throw entriesError;

      // Get member data
      const memberIds = [...new Set(entriesData.map(entry => entry.member_id))];
      const { data: membersData } = await supabase
        .from('members')
        .select('id, name')
        .in('id', memberIds);

      // Get category data
      const categoryIds = [...new Set(entriesData.map(entry => entry.bjcp_category_id).filter(Boolean))];
      const { data: categoriesData } = await supabase
        .from('bjcp_categories')
        .select('id, category_name, category_number, subcategory_letter, subcategory_name')
        .in('id', categoryIds);

      // Load ranking groups if using custom system
      let rankingGroups = [];
      if (competition.category_system === 'custom') {
        const { data: groupsData, error: groupsError } = await supabase
          .from('competition_ranking_groups')
          .select('*')
          .eq('competition_id', competition.id)
          .order('group_order');

        if (!groupsError) {
          rankingGroups = groupsData || [];
        }
      }

      // Load rankings data for points calculation
      const { data: rankingsData, error: rankingsError } = await supabase
        .from('competition_rankings')
        .select(`
          *,
          entry:competition_entries!inner(id, entry_number, beer_name),
          judge:members!competition_rankings_judge_id_fkey(id, name),
          category:bjcp_categories(category_name, category_number, subcategory_letter),
          ranking_group:competition_ranking_groups(id, group_name, group_description)
        `)
        .eq('competition_id', competition.id)
        .order('bjcp_category_id')
        .order('rank_position');

      const rankings = rankingsData || [];

      // Combine all data
      results = resultsData.map(result => {
        const entry = entriesData.find(e => e.id === result.entry_id);
        const member = membersData?.find(m => m.id === entry?.member_id);
        const category = categoriesData?.find(c => c.id === entry?.bjcp_category_id);

        const categoryDisplay = category 
          ? `${category.category_number}${category.subcategory_letter || ''} - ${category.category_name}`
          : 'Unknown Category';

        // Find ranking group for this entry's category
        let rankingGroupName = null;
        if (rankingGroups.length > 0 && entry?.bjcp_category_id) {
          const group = rankingGroups.find(g => 
            g.bjcp_category_ids.includes(entry.bjcp_category_id)
          );
          rankingGroupName = group?.group_name || null;
        }

        // Calculate ranking points for this entry
        const rankingPoints = entry?.bjcp_category_id 
          ? calculateEntryPoints(entry.id, entry.bjcp_category_id, rankings, rankingGroups)
          : { totalPoints: 0, judgeCount: 0, rankings: [] };

        return {
          ...result,
          entry_number: entry?.entry_number || 'N/A',
          beer_name: entry?.beer_name || 'Unknown Beer',
          member_name: member?.name || 'Unknown Member',
          category_display: categoryDisplay,
          ranking_group_name: rankingGroupName,
          // Use ranking group for display if available, otherwise use individual category
          display_group: rankingGroupName || categoryDisplay,
          category_number: category?.category_number || '',
          subcategory_letter: category?.subcategory_letter || '',
          // Ranking points
          ranking_points: rankingPoints.totalPoints,
          judge_count: rankingPoints.judgeCount
        };
      });

      console.log('Loaded', results.length, 'results');

    } catch (err) {
      console.error('Error loading results:', err);
      error = err.message || 'Failed to load results';
    } finally {
      isLoadingResults = false;
    }
  }

  // Get placement display
  function getPlacementDisplay(placement) {
    switch (placement) {
      case '1':
        return { text: '1st Place', class: 'placement-first', medal: '🥇' };
      case '2':
        return { text: '2nd Place', class: 'placement-second', medal: '🥈' };
      case '3':
        return { text: '3rd Place', class: 'placement-third', medal: '🥉' };
      case 'HM':
        return { text: 'Honorable Mention', class: 'placement-hm', medal: '🏅' };
      default:
        return { text: 'No Placement', class: 'placement-none', medal: '' };
    }
  }

  // Calculate placement based on ranking points within each category/group, with score fallback
  function calculateRankingBasedPlacement(results) {
    const resultsByGroup = results.reduce((acc, result) => {
      const groupKey = result.display_group;
      if (!acc[groupKey]) {
        acc[groupKey] = [];
      }
      acc[groupKey].push(result);
      return acc;
    }, {});

    // Process each group
    Object.keys(resultsByGroup).forEach(groupKey => {
      const groupResults = resultsByGroup[groupKey];
      
      // Check if any entries in this group have ranking points
      const hasRankingPoints = groupResults.some(result => result.ranking_points > 0);

      if (hasRankingPoints) {
        // Use ranking points system
        groupResults.sort((a, b) => {
          if (b.ranking_points !== a.ranking_points) {
            return b.ranking_points - a.ranking_points;
          }
          // Tiebreaker: use score
          return (b.score || 0) - (a.score || 0);
        });

        // Assign placement based on ranking points position
        let currentRank = 1;
        let previousPoints = null;

        groupResults.forEach((result, index) => {
          if (previousPoints !== null && result.ranking_points < previousPoints) {
            currentRank = index + 1;
          }

          // Only assign placement if there are ranking points
          if (result.ranking_points > 0) {
            if (currentRank === 1) {
              result.calculated_placement = '1';
            } else if (currentRank === 2) {
              result.calculated_placement = '2';
            } else if (currentRank === 3) {
              result.calculated_placement = '3';
            } else if (currentRank <= 6) { // Top 6 get honorable mention
              result.calculated_placement = 'HM';
            } else {
              result.calculated_placement = '';
            }
          } else {
            result.calculated_placement = '';
          }

          previousPoints = result.ranking_points;
        });
      } else {
        // Fallback to score-based system when no ranking points exist
        groupResults.sort((a, b) => {
          return (b.score || 0) - (a.score || 0);
        });

        // Assign placement based on score position
        let currentRank = 1;
        let previousScore = null;

        groupResults.forEach((result, index) => {
          const currentScore = result.score || 0;
          
          if (previousScore !== null && currentScore < previousScore) {
            currentRank = index + 1;
          }

          // Assign placement based on score (only for entries with scores > 0)
          if (currentScore > 0) {
            if (currentRank === 1) {
              result.calculated_placement = '1';
            } else if (currentRank === 2) {
              result.calculated_placement = '2';
            } else if (currentRank === 3) {
              result.calculated_placement = '3';
            } else if (currentRank <= 6) { // Top 6 get honorable mention
              result.calculated_placement = 'HM';
            } else {
              result.calculated_placement = '';
            }
          } else {
            result.calculated_placement = '';
          }

          previousScore = currentScore;
        });
      }
    });

    return resultsByGroup;
  }

  // Group results by category or ranking group and calculate ranking-based placements
  $: resultsByCategory = calculateRankingBasedPlacement(results);

  // Get awards summary based on calculated placements
  $: awardsSummary = {
    totalEntries: results.length,
    placedEntries: results.filter(r => r.calculated_placement && r.calculated_placement !== '').length,
    categories: Object.keys(resultsByCategory).length,
    averageScore: results.length > 0 
      ? Math.round((results.reduce((sum, r) => sum + (r.score || 0), 0) / results.length) * 10) / 10
      : 0
  };

  // Format date
  function formatDate(dateString) {
    if (!dateString) return 'No date set';
    try {
      // Handle space-separated datetime format (e.g., "2025-08-29 03:43:21.894974")
      let isoString = dateString;
      if (dateString.includes(' ') && !dateString.includes('T')) {
        // Replace space with 'T' and add timezone if missing
        isoString = dateString.replace(' ', 'T');
        if (!isoString.includes('+') && !isoString.includes('Z')) {
          // Assume local timezone if no timezone specified
          isoString += 'Z';
        }
      }

      const date = new Date(isoString);
      // Check if date is valid
      if (isNaN(date.getTime())) {
        console.warn('Invalid date after parsing:', dateString, '->', isoString);
        return 'Invalid Date';
      }

      return date.toLocaleDateString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long', 
        day: 'numeric'
      });
    } catch (error) {
      console.warn('Error formatting date:', dateString, error);
      return 'Invalid Date';
    }
  }

  // Navigate back to competitions
  function navigateToCompetitions() {
    goto('/competitions');
  }

  // Load scoresheet data for a specific entry
  async function loadScoresheetData(entryId) {
    loadingScoresheet = true;
    scoresheetError = null;
    selectedScoresheet = null;

    try {
      console.log('Loading scoresheet for entry:', entryId);
      
      // Get judging sessions for this entry
      const { data: sessions, error: sessionsError } = await supabase
        .from('competition_judging_sessions')
        .select(`
          *,
          judge:members!competition_judging_sessions_judge_id_fkey(id, name),
          entry:competition_entries(
            id, 
            entry_number, 
            beer_name, 
            member_id, 
            bjcp_category_id,
            category:bjcp_categories(id, category_name, category_number, subcategory_letter, subcategory_name)
          )
        `)
        .eq('entry_id', entryId)
        .eq('competition_id', selectedCompetition.id);

      if (sessionsError) throw sessionsError;

      if (!sessions || sessions.length === 0) {
        scoresheetError = 'No scoresheets found for this entry.';
        return;
      }

      selectedScoresheet = {
        entry: sessions[0].entry,
        category: sessions[0].entry?.category,
        sessions: sessions.map(session => ({
          id: session.id,
          judge: session.judge,
          total_score: session.total_score,
          judge_notes: session.judge_notes,
          scoresheet_data: session.scoresheet_data,
          judged_at: session.judged_at,
          // Simple scoresheet data (fallback)
          aroma_score: session.aroma_score,
          appearance_score: session.appearance_score,
          flavor_score: session.flavor_score,
          mouthfeel_score: session.mouthfeel_score,
          overall_score: session.overall_score
        }))
      };

      showScoresheetModal = true;

    } catch (err) {
      console.error('Error loading scoresheet:', err);
      scoresheetError = err.message || 'Failed to load scoresheet data';
    } finally {
      loadingScoresheet = false;
    }
  }

  // Close scoresheet modal
  function closeScoresheetModal() {
    showScoresheetModal = false;
    selectedScoresheet = null;
    scoresheetError = null;
  }
</script>

<style>
  .container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 1rem;
  }

  .hero {
    text-align: center;
    margin-bottom: 3rem;
    padding: 3rem 1rem;
  }

  .hero h1 {
    color: #ff3e00;
    font-size: 3.5rem;
    font-weight: 100;
    text-transform: uppercase;
    margin: 0 0 1rem 0;
    letter-spacing: 3px;
  }

  .hero p {
    font-size: 1.2rem;
    color: #666;
    margin: 0;
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
  }

  .competition-selector {
    background: white;
    padding: 1.5rem;
    border-radius: 6px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    border-left: 4px solid #ff3e00;
    margin-bottom: 2rem;
  }

  .selector-label {
    font-size: 1rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 1rem;
  }

  .competition-select {
    width: 100%;
    max-width: 400px;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 1rem;
    background: white;
    color: #333;
  }

  .competition-select:focus {
    outline: none;
    border-color: #ff3e00;
    box-shadow: 0 0 0 3px rgba(255, 62, 0, 0.1);
  }

  .results-summary {
    background: white;
    padding: 1.5rem;
    border-radius: 6px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    border-left: 4px solid #ff3e00;
    margin-bottom: 2rem;
  }

  .summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
  }

  .summary-item {
    text-align: center;
    padding: 1rem;
    background: #f9f9f9;
    border-radius: 6px;
  }

  .summary-label {
    font-size: 0.875rem;
    color: #666;
    margin-bottom: 0.5rem;
  }

  .summary-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: #ff3e00;
  }

  .category-section {
    background: white;
    border-radius: 6px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    margin-bottom: 2rem;
  }

  .category-header {
    background: #f5f5f5;
    padding: 1rem 1.5rem;
    border-bottom: 2px solid #ddd;
  }

  .category-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: #333;
    margin: 0;
  }

  .results-table {
    width: 100%;
    border-collapse: collapse;
  }

  .results-table th {
    background: #fafafa;
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    color: #333;
    border-bottom: 1px solid #ddd;
  }

  .results-table td {
    padding: 1rem;
    border-bottom: 1px solid #eee;
  }

  .results-table tr:hover {
    background: #f9f9f9;
  }

  .clickable-row {
    cursor: pointer;
    transition: background-color 0.2s ease;
  }

  .clickable-row:hover {
    background: #f0f9ff !important;
  }

  .clickable-card {
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .clickable-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .placement-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.875rem;
    font-weight: 600;
  }

  .placement-first {
    background: #fef3c7;
    color: #92400e;
  }

  .placement-second {
    background: #f3f4f6;
    color: #6b7280;
  }

  .placement-third {
    background: #fecaca;
    color: #b91c1c;
  }

  .placement-hm {
    background: #ddd6fe;
    color: #7c3aed;
  }

  .placement-none {
    background: #f9fafb;
    color: #6b7280;
  }

  .score-badge {
    background: #e0f2fe;
    color: #0369a1;
    padding: 0.25rem 0.5rem;
    border-radius: 6px;
    font-weight: 600;
  }

  .entry-number {
    font-weight: 600;
    color: #ff3e00;
  }

  .judge-notes {
    font-style: italic;
    color: #666;
    max-width: 300px;
    line-height: 1.4;
  }

  .controls {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
    flex-wrap: wrap;
    align-items: center;
  }

  .btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 6px;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-block;
  }

  .btn-secondary {
    background: #6b7280;
    color: white;
  }

  .btn-secondary:hover {
    background: #4b5563;
  }

  .loading, .empty-state {
    text-align: center;
    padding: 3rem;
    color: #666;
  }

  .spinner {
    display: inline-block;
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #ff3e00;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 1rem;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .error {
    background: #fee2e2;
    color: #dc2626;
    padding: 1rem;
    border-radius: 6px;
    margin-bottom: 1rem;
  }

  /* Mobile styles */
  @media (max-width: 768px) {
    .hero h1 {
      font-size: 2.5rem;
      letter-spacing: 2px;
    }
    .hero {
      padding: 2rem 1rem;
    }

    .competition-grid {
      grid-template-columns: 1fr;
    }

    .summary-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .results-table {
      font-size: 0.875rem;
    }

    .results-table th,
    .results-table td {
      padding: 0.75rem 0.5rem;
    }

    .judge-notes {
      max-width: 200px;
    }

    .controls {
      flex-direction: column;
      align-items: stretch;
    }
  }

  /* Mobile Card Styles */
  .results-cards {
    display: none;
  }

  .result-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    margin-bottom: 1rem;
    padding: 1rem;
    border-left: 4px solid #ff3e00;
  }

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
  }

  .entry-info {
    flex: 1;
  }

  .entry-number {
    font-size: 0.875rem;
    color: #666;
    font-weight: 500;
  }

  .beer-name {
    font-size: 1.125rem;
    font-weight: 600;
    color: #333;
    margin: 0.25rem 0;
  }

  .member-name {
    font-size: 0.875rem;
    color: #666;
    margin: 0;
  }

  .ranking-info {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 0.5rem;
  }

  .placement-badge-mobile {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.875rem;
    font-weight: 600;
    text-align: center;
  }

  .placement-badge-mobile.placement-1 {
    background: linear-gradient(135deg, #ffd700, #ffed4a);
    color: #744210;
  }

  .placement-badge-mobile.placement-2 {
    background: linear-gradient(135deg, #c0c0c0, #e2e8f0);
    color: #4a5568;
  }

  .placement-badge-mobile.placement-3 {
    background: linear-gradient(135deg, #cd7f32, #d69e2e);
    color: #744210;
  }

  .placement-badge-mobile.placement-none {
    background: #f7fafc;
    color: #718096;
    border: 1px solid #e2e8f0;
  }

  .card-details {
    border-top: 1px solid #f1f5f9;
    padding-top: 1rem;
  }

  .detail-row {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .detail-item {
    text-align: center;
  }

  .detail-label {
    display: block;
    font-size: 0.75rem;
    color: #666;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.25rem;
  }

  .detail-value {
    display: block;
    font-size: 0.875rem;
    font-weight: 600;
    color: #333;
  }

  .judge-notes-mobile {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #f1f5f9;
  }

  .notes-label {
    display: block;
    font-size: 0.75rem;
    color: #666;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.5rem;
  }

  .notes-text {
    font-size: 0.875rem;
    color: #333;
    line-height: 1.4;
    margin: 0;
  }

  /* Responsive visibility */
  @media (max-width: 768px) {
    .desktop-view {
      display: none;
    }

    .mobile-view {
      display: block;
    }
  }

  @media (max-width: 480px) {
    .container {
      padding: 0.5rem;
    }

    .hero h1 {
      font-size: 2rem;
    }

    .summary-grid {
      grid-template-columns: 1fr;
    }

    .result-card {
      padding: 0.75rem;
    }

    .detail-row {
      grid-template-columns: 1fr;
      gap: 0.75rem;
    }

    .detail-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      text-align: left;
    }

    .detail-label {
      margin-bottom: 0;
    }
  }

  /* Scoresheet Modal Styles */
  .modal-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    z-index: 1000;
  }

  .modal-content {
    background: white;
    border-radius: 8px;
    max-width: 800px;
    width: 100%;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  .scoresheet-modal {
    max-width: 900px;
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid #eee;
    flex-shrink: 0;
  }

  .modal-header h2 {
    margin: 0;
    color: #333;
    font-size: 1.5rem;
  }

  .close-button {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: #666;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 4px;
    transition: background-color 0.2s;
  }

  .close-button:hover {
    background: #f5f5f5;
  }

  .modal-body {
    flex: 1;
    overflow-y: auto;
  }

  .scoresheet-body {
    padding: 1.5rem;
  }

  .entry-info-header {
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #f0f0f0;
  }

  .entry-info-header h3 {
    margin: 0 0 0.5rem 0;
    color: #333;
    font-size: 1.3rem;
  }

  .category-info {
    margin: 0;
    color: #666;
    font-size: 1rem;
  }

  .judge-session {
    margin-bottom: 2rem;
    padding: 1.5rem;
    background: #fafafa;
    border-radius: 8px;
    border: 1px solid #e5e5e5;
  }

  .session-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .session-header h4 {
    margin: 0;
    color: #333;
    font-size: 1.2rem;
  }

  .session-meta {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 0.5rem;
  }

  .total-score {
    font-weight: 600;
    color: #ff3e00;
    font-size: 1.1rem;
  }

  .judged-date {
    color: #666;
    font-size: 0.9rem;
  }

  .bjcp-scoresheet, .simple-scoresheet {
    margin-bottom: 1.5rem;
  }

  .bjcp-scoresheet h5, .simple-scoresheet h5 {
    margin: 0 0 1rem 0;
    color: #333;
    font-size: 1.1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #ddd;
  }

  .score-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  .score-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 0.75rem;
    background: white;
    border-radius: 6px;
    border: 1px solid #ddd;
  }

  .score-label {
    font-size: 0.9rem;
    color: #666;
    margin-bottom: 0.25rem;
  }

  .score-value {
    font-size: 1.1rem;
    font-weight: 600;
    color: #333;
  }

  .comments-section {
    margin-bottom: 1.5rem;
  }

  .comment-item {
    margin-bottom: 1rem;
    padding: 1rem;
    background: white;
    border-radius: 6px;
    border-left: 4px solid #ff3e00;
  }

  .comment-item h6 {
    margin: 0 0 0.5rem 0;
    color: #333;
    font-size: 1rem;
    font-weight: 600;
  }

  .comment-item p {
    margin: 0;
    color: #555;
    line-height: 1.5;
  }

  .descriptors-section {
    margin-bottom: 1.5rem;
  }

  .descriptors-section h6 {
    margin: 0 0 0.75rem 0;
    color: #333;
    font-size: 1rem;
    font-weight: 600;
  }

  .descriptor-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .descriptor-tag {
    background: #e3f2fd;
    color: #1976d2;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 500;
    text-transform: capitalize;
  }

  .judge-notes-section {
    padding: 1rem;
    background: white;
    border-radius: 6px;
    border-left: 4px solid #059669;
  }

  .judge-notes-section h6 {
    margin: 0 0 0.5rem 0;
    color: #333;
    font-size: 1rem;
    font-weight: 600;
  }

  .judge-notes-text {
    margin: 0;
    color: #555;
    line-height: 1.5;
    font-style: italic;
  }

  .session-divider {
    margin: 2rem 0;
    border: none;
    height: 1px;
    background: #ddd;
  }

  .no-scoresheets {
    text-align: center;
    padding: 2rem;
    color: #666;
  }

  .error-message {
    color: #dc2626;
    text-align: center;
    padding: 1rem;
  }

  /* Mobile responsive for modal */
  @media (max-width: 768px) {
    .modal-content {
      margin: 0.5rem;
      max-height: calc(100vh - 1rem);
    }

    .scoresheet-body {
      padding: 1rem;
    }

    .session-header {
      flex-direction: column;
      align-items: flex-start;
    }

    .session-meta {
      align-items: flex-start;
    }

    .score-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 480px) {
    .score-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<div class="container">
  <!-- Hero Section -->
  <div class="hero">
    <h1>Competition Results</h1>
    <p>View published competition results and standings</p>
  </div>

  <!-- Controls -->
  <div class="controls">
    <button class="btn btn-secondary" on:click={navigateToCompetitions}>
      Back to Competitions
    </button>
  </div>

  <!-- Error State -->
  {#if error}
    <div class="error">
      {error}
    </div>
  {/if}

  <!-- Loading State -->
  {#if isLoading}
    <div class="loading">
      <div class="spinner"></div>
      <p>Loading competition results...</p>
    </div>
  {:else if competitions.length === 0}
    <!-- No Published Results -->
    <div class="empty-state">
      <h3>No Results Published</h3>
      <p>There are currently no competition results available to view.</p>
      <p>Check back after competitions have been judged and results published.</p>
    </div>
  {:else}
    <!-- Competition Selector -->
    <div class="competition-selector">
      <div class="selector-label">Select Competition to View Results:</div>
      <select 
        class="competition-select" 
        on:change={handleCompetitionSelect}
        value={selectedCompetition?.id || ''}
      >
        <option value="">Choose a competition...</option>
        {#each competitions as competition}
          <option value={competition.id}>
            {competition.name} - Judged {formatDate(competition.judging_date)}
          </option>
        {/each}
      </select>
    </div>

    {#if selectedCompetition}
      <!-- Results Summary -->
      {#if !isLoadingResults && results.length > 0}
        <div class="results-summary">
          <h2 style="margin: 0 0 1.5rem 0; color: #333;">{selectedCompetition.name} - Results Summary</h2>
          <div class="summary-grid">
            <div class="summary-item">
              <div class="summary-label">Total Entries</div>
              <div class="summary-value">{awardsSummary.totalEntries}</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Awards Given</div>
              <div class="summary-value">{awardsSummary.placedEntries}</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Categories</div>
              <div class="summary-value">{awardsSummary.categories}</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Average Score</div>
              <div class="summary-value">{awardsSummary.averageScore}</div>
            </div>
          </div>
        </div>
      {/if}

      <!-- Results by Category -->
      {#if isLoadingResults}
        <div class="loading">
          <div class="spinner"></div>
          <p>Loading results...</p>
        </div>
      {:else if results.length === 0}
        <div class="empty-state">
          <h3>No Results Available</h3>
          <p>Results for this competition have not been entered yet.</p>
        </div>
      {:else}
        {#each Object.entries(resultsByCategory) as [categoryName, categoryResults]}
          <div class="category-section">
            <div class="category-header">
              <h3 class="category-title">{categoryName}</h3>
            </div>
            
            <!-- Desktop Table View -->
            <table class="results-table desktop-view">
              <thead>
                <tr>
                  <th>Entry</th>
                  <th>Member</th>
                  <th>Beer Name</th>
                  <th>Ranking Points</th>
                  <th>Score</th>
                  <th>Placement</th>
                  <th>Judge Notes</th>
                </tr>
              </thead>
              <tbody>
                {#each categoryResults as result}
                  <tr class="clickable-row" on:click={() => loadScoresheetData(result.entry_id)} title="Click to view scoresheet">
                    <td>
                      <span class="entry-number">{result.entry_number}</span>
                    </td>
                    <td>{result.member_name}</td>
                    <td>{result.beer_name}</td>
                    <td>
                      <span style="font-weight: 600; color: {result.ranking_points > 0 ? '#059669' : '#666'};">
                        {result.ranking_points} {result.ranking_points === 1 ? 'pt' : 'pts'}
                      </span>
                      {#if result.judge_count > 0}
                        <br><small style="color: #666;">{result.judge_count} judge{result.judge_count === 1 ? '' : 's'}</small>
                      {/if}
                    </td>
                    <td>
                      {#if result.score}
                        <span class="score-badge">{result.score}/50</span>
                      {:else}
                        <span class="score-badge">-/50</span>
                      {/if}
                    </td>
                    <td>
                      {#if result.calculated_placement}
                        <span class="placement-badge {getPlacementDisplay(result.calculated_placement).class}">
                          <span>{getPlacementDisplay(result.calculated_placement).medal}</span>
                          <span>{getPlacementDisplay(result.calculated_placement).text}</span>
                        </span>
                      {:else}
                        <span class="placement-badge placement-none">No Placement</span>
                      {/if}
                    </td>
                    <td>
                      {#if result.judge_notes}
                        <div class="judge-notes">{result.judge_notes}</div>
                      {:else}
                        <span style="color: #999;">No notes</span>
                      {/if}
                    </td>
                  </tr>
                {/each}
              </tbody>
            </table>

            <!-- Mobile Card View -->
            <div class="results-cards mobile-view">
              {#each categoryResults as result}
                <div class="result-card clickable-card" on:click={() => loadScoresheetData(result.entry_id)} title="Tap to view scoresheet">
                  <div class="card-header">
                    <div class="entry-info">
                      <span class="entry-number">#{result.entry_number}</span>
                      <h4 class="beer-name">{result.beer_name}</h4>
                      <p class="member-name">{result.member_name}</p>
                    </div>
                    <div class="ranking-info">
                      {#if result.calculated_placement}
                        <div class="placement-badge-mobile {getPlacementDisplay(result.calculated_placement).class}">
                          <span class="medal">{getPlacementDisplay(result.calculated_placement).medal}</span>
                          <span class="placement-text">{getPlacementDisplay(result.calculated_placement).text}</span>
                        </div>
                      {:else}
                        <div class="placement-badge-mobile placement-none">No Placement</div>
                      {/if}
                    </div>
                  </div>
                  
                  <div class="card-details">
                    <div class="detail-row">
                      <div class="detail-item">
                        <span class="detail-label">Points</span>
                        <span class="detail-value" style="color: {result.ranking_points > 0 ? '#059669' : '#666'}; font-weight: 600;">
                          {result.ranking_points} {result.ranking_points === 1 ? 'pt' : 'pts'}
                        </span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Score</span>
                        <span class="detail-value">
                          {#if result.score}
                            {result.score}/50
                          {:else}
                            -/50
                          {/if}
                        </span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Judges</span>
                        <span class="detail-value">{result.judge_count}</span>
                      </div>
                    </div>
                    
                    {#if result.judge_notes}
                      <div class="judge-notes-mobile">
                        <span class="notes-label">Judge Notes</span>
                        <p class="notes-text">{result.judge_notes}</p>
                      </div>
                    {/if}
                  </div>
                </div>
              {/each}
            </div>
          </div>
        {/each}
      {/if}
    {/if}
  {/if}
</div>

<!-- Scoresheet Modal -->
{#if showScoresheetModal}
  <div class="modal-backdrop" on:click={closeScoresheetModal}>
    <div class="modal-content scoresheet-modal" on:click|stopPropagation>
      <div class="modal-header">
        <h2>📋 Scoresheet Details</h2>
        <button class="close-button" on:click={closeScoresheetModal}>✕</button>
      </div>

      {#if loadingScoresheet}
        <div class="modal-body">
          <div class="loading">
            <div class="spinner"></div>
            <p>Loading scoresheet...</p>
          </div>
        </div>
      {:else if scoresheetError}
        <div class="modal-body">
          <div class="error-state">
            <p class="error-message">{scoresheetError}</p>
          </div>
        </div>
      {:else if selectedScoresheet}
        <div class="modal-body scoresheet-body">
          <!-- Entry Information -->
          <div class="entry-info-header">
            <h3>Entry #{selectedScoresheet.entry.entry_number}: {selectedScoresheet.entry.beer_name}</h3>
            {#if selectedScoresheet.category}
              <p class="category-info">
                {selectedScoresheet.category.category_number}{selectedScoresheet.category.subcategory_letter} - {selectedScoresheet.category.category_name}
                {#if selectedScoresheet.category.subcategory_name}
                  ({selectedScoresheet.category.subcategory_name})
                {/if}
              </p>
            {/if}
          </div>

          <!-- Judge Sessions -->
          {#if selectedScoresheet.sessions && selectedScoresheet.sessions.length > 0}
            {#each selectedScoresheet.sessions as session, index}
              <div class="judge-session">
                <div class="session-header">
                  <h4>Judge: {session.judge.name}</h4>
                  <div class="session-meta">
                    <span class="total-score">Total Score: {session.total_score || 'N/A'}/50</span>
                    {#if session.judged_at}
                      <span class="judged-date">
                        Judged: {formatDate(session.judged_at)}
                      </span>
                    {/if}
                  </div>
                </div>

                <!-- BJCP Scoresheet Data (if available) -->
                {#if session.scoresheet_data}
                  <div class="bjcp-scoresheet">
                    <h5>📊 BJCP Scoresheet</h5>
                    
                    <!-- Score Breakdown -->
                    <div class="score-grid">
                      {#if session.scoresheet_data.aroma_score}
                        <div class="score-item">
                          <span class="score-label">Aroma</span>
                          <span class="score-value">{session.scoresheet_data.aroma_score}/12</span>
                        </div>
                      {/if}
                      {#if session.scoresheet_data.appearance_score}
                        <div class="score-item">
                          <span class="score-label">Appearance</span>
                          <span class="score-value">{session.scoresheet_data.appearance_score}/3</span>
                        </div>
                      {/if}
                      {#if session.scoresheet_data.flavor_score}
                        <div class="score-item">
                          <span class="score-label">Flavor</span>
                          <span class="score-value">{session.scoresheet_data.flavor_score}/20</span>
                        </div>
                      {/if}
                      {#if session.scoresheet_data.mouthfeel_score}
                        <div class="score-item">
                          <span class="score-label">Mouthfeel</span>
                          <span class="score-value">{session.scoresheet_data.mouthfeel_score}/5</span>
                        </div>
                      {/if}
                      {#if session.scoresheet_data.overall_score}
                        <div class="score-item">
                          <span class="score-label">Overall</span>
                          <span class="score-value">{session.scoresheet_data.overall_score}/10</span>
                        </div>
                      {/if}
                    </div>

                    <!-- Comments -->
                    <div class="comments-section">
                      {#if session.scoresheet_data.aroma_comments}
                        <div class="comment-item">
                          <h6>Aroma</h6>
                          <p>{session.scoresheet_data.aroma_comments}</p>
                        </div>
                      {/if}
                      {#if session.scoresheet_data.appearance_comments}
                        <div class="comment-item">
                          <h6>Appearance</h6>
                          <p>{session.scoresheet_data.appearance_comments}</p>
                        </div>
                      {/if}
                      {#if session.scoresheet_data.flavor_comments}
                        <div class="comment-item">
                          <h6>Flavor</h6>
                          <p>{session.scoresheet_data.flavor_comments}</p>
                        </div>
                      {/if}
                      {#if session.scoresheet_data.mouthfeel_comments}
                        <div class="comment-item">
                          <h6>Mouthfeel</h6>
                          <p>{session.scoresheet_data.mouthfeel_comments}</p>
                        </div>
                      {/if}
                      {#if session.scoresheet_data.overall_comments}
                        <div class="comment-item">
                          <h6>Overall Impression</h6>
                          <p>{session.scoresheet_data.overall_comments}</p>
                        </div>
                      {/if}
                    </div>

                    <!-- Descriptors (if any are selected) -->
                    {#if session.scoresheet_data.descriptors}
                      {@const selectedDescriptors = Object.entries(session.scoresheet_data.descriptors).filter(([key, value]) => value)}
                      {#if selectedDescriptors.length > 0}
                        <div class="descriptors-section">
                          <h6>Descriptors</h6>
                          <div class="descriptor-tags">
                            {#each selectedDescriptors as [descriptor, _]}
                              <span class="descriptor-tag">{descriptor.replace('_', ' ')}</span>
                            {/each}
                          </div>
                        </div>
                      {/if}
                    {/if}
                  </div>
                {:else}
                  <!-- Simple scoresheet fallback -->
                  <div class="simple-scoresheet">
                    <h5>📝 Basic Scoresheet</h5>
                    <div class="score-grid">
                      {#if session.aroma_score}
                        <div class="score-item">
                          <span class="score-label">Aroma</span>
                          <span class="score-value">{session.aroma_score}/12</span>
                        </div>
                      {/if}
                      {#if session.appearance_score}
                        <div class="score-item">
                          <span class="score-label">Appearance</span>
                          <span class="score-value">{session.appearance_score}/3</span>
                        </div>
                      {/if}
                      {#if session.flavor_score}
                        <div class="score-item">
                          <span class="score-label">Flavor</span>
                          <span class="score-value">{session.flavor_score}/20</span>
                        </div>
                      {/if}
                      {#if session.mouthfeel_score}
                        <div class="score-item">
                          <span class="score-label">Mouthfeel</span>
                          <span class="score-value">{session.mouthfeel_score}/5</span>
                        </div>
                      {/if}
                      {#if session.overall_score}
                        <div class="score-item">
                          <span class="score-label">Overall</span>
                          <span class="score-value">{session.overall_score}/10</span>
                        </div>
                      {/if}
                    </div>
                  </div>
                {/if}

                <!-- Judge Notes -->
                {#if session.judge_notes}
                  <div class="judge-notes-section">
                    <h6>Judge Notes</h6>
                    <p class="judge-notes-text">{session.judge_notes}</p>
                  </div>
                {/if}
              </div>

              {#if index < selectedScoresheet.sessions.length - 1}
                <hr class="session-divider">
              {/if}
            {/each}
          {:else}
            <div class="no-scoresheets">
              <p>No detailed scoresheets available for this entry.</p>
            </div>
          {/if}
        </div>
      {/if}
    </div>
  </div>
{/if}